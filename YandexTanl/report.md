# Нагрузочное тестирование с помощью Yandex.Tank

## Ammo Generator

Код генератора можно посмотреть [тут](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/src/main/java/ru/mail/polis/service/ivanovandrey/AmmoGenerator.java)

В соответствии с заданием он генерирует патроны в пяти режимах:

  Лента с PUTами с уникальными ключами
  
  Лента с PUTами с частичной перезаписью ключей (вероятность 10%)
  
  
  Лента с GETами существующих ключей с равномерным распределением (стреляем по наполненной БД)
  
  То же самое, но со смещением распределения GETов к недавно добавленным ключам (частый случай на практике)
  
  Лента со смешанной нагрузкой с 50% PUTы новых ключей и 50% GETы существующих ключей (равномерное распределение)
  
  Для определения существующих ключей был выбран примитиный принцип, опирающийся на то, что все ключи являются числами от 0 до заданного количества. 
Благодаря этому можно либо вообще не хранить листа с запросами в памяти программы, либо использовать интовую переменную.

Yandex.Tank был собран через докер, файлы load.yaml и token.txt настроены в соответствии с образцом.
Строка для запуска совпадает с приведенной в документации

```
docker run -v "$(pwd):/var/loadtest" -v "$HOME/.ssh:/root/.ssh" -it direvius/yandex-tank

```

# Полученный результат
## Выяснение нагрузки
Изначально было задано линейно растущее от времени количество запросов в секунду от 1 до 5000. Так как на не самом силбном компе запущена виртуалка, вся эта конструкция пошатнулась 
на тысяче запросов в секунду. Было принято решение стрелять по 500 константой, чтобы наверняка. Но тут пошли странности. Примерно пять сотых щапросов возвращались с кодом 71 Protocol Error/
Кластер при этом выдавал ошибку 504 Not Enough Replica. Не помогло снижение нагрузки, снижение обьема записи, даже профилирование других сервисов, которых не коснулись мои кривыые руки
выдавало те же самые ошибки 504. Получив благослаение от преподавателя я спишу этот факт на мой компьютер и выкрутасы GC. Но от этого нагрузка во всей работе была всего в 250 rps
А так же везде, где наследили запросы put около 0.05 процентов ответов будут ошибками. Таков путь...

[Результат пробной стрельбы](https://overload.yandex.net/350578#tab=test_data&tags=&plot_groups=main&machines=&metrics=&slider_start=1605523782&slider_end=1605523850&compress_ratio=1
)

## Первый этоап. Стрельба уникальными Put-запросами

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/one.PNG?raw=true)

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/one1.PNG?raw=true)

По времени ответа неплохо для моей старушки, по графикам тоже выглядит нормально, сервер справляется, кроме одного пика. 
Знаете, во вселенной много всего не изученного и если чего не могут понять - валят на темную материю. У меня за темную материю будет сборщик мусора. Он тоже не особо понятный и если что-то не 
так - наверное потому что он. Что-то где-то преполнилось и очищается. Либо попало в такую область памяти нод, либо я не очень знаю откуда этот пик и почему он один.

[Ссылка на результат](https://overload.yandex.net/350851#tab=test_data&tags=&plot_groups=main&machines=&metrics=&slider_start=1605539129&slider_end=1605539429)

## Второй этоап. Стрельба Put-запросами с перезаписью в одном из 10 случаев

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/two.PNG?raw=true)

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/two2.PNG?raw=true)

Вот тут уже более понятная мне картина. Сервер тоже справился, но перезапись очевидно более долгая операция. чем просто запись, что и видно на графике.

[Ссылка на результат](https://overload.yandex.net/350899#tab=test_data&tags=&plot_groups=main&machines=&metrics=&slider_start=1605541051&slider_end=1605541351)

## Третий этоап. Стрельба Get-запросами существующих ключей с равномерным распределением

Вот тут сначала было забавно. Сервер выдавал вот такое

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/threeFail.PNG?raw=true)

Недолго подумав я понял откуда ноги растут. Количество моих патронов было рассчитано на стрельбу со скоростью сильно большей, чем итоговая. В итоге не далеко не всеми пут запросами в итоге выстрелили.
А генератор гет запросов считал что путов до него было столько же, сколько у него гетов и генерировал случайные числа из общего пула. 

Когда я пофиксил вышло вот так.

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/three.PNG?raw=true)

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/three3.PNG?raw=true)

Тут все выгляжит красиво, ошибки прекратили душить, все здорово, но есть пик. Не знаю откуда, темная материя, сборщик мусора и прочая аргуменация из первого пункта(

[Ссылка на результат](https://overload.yandex.net/350852#tab=test_data&tags=&plot_groups=main&machines=&metrics=&slider_start=1605539453&slider_end=1605539753
)

## Четвертый этап. Стрельба Get-запросами существующих ключей с смещением распределения 

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/four.PNG?raw=true)

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/four4.PNG?raw=true)

Тут у меня есть теория почему так. Вроде как для доступа к конечной записи в ноде нужно проитерироваться от первой и при распределении неравномерном, а как тут сложность операции 
меняется. Как следствие дольше, на графиках видно, но сервер справляется. Надеюсь я критически не ошибся в ствоем предположении.

[Ссылка на результат](https://overload.yandex.net/350865#tab=test_data&tags=&plot_groups=main&machines=&metrics=&slider_start=1605539823&slider_end=1605540123)

## Пятый этап. Лента со смешанной нагрузкой

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/five.PNG?raw=true)

![alt text](https://github.com/IvanovAndrey/2020-highload-dht/blob/YandexTank/YandexTanl/five5.PNG?raw=true)

Тут видно во-первых что запросы действительно были двух типов, во вторых действительно их было почти поровну, а в третьих не было 404 от гетов, что значит что хорошо сработал генератор патронов.
Ну и наш старый знакомы пик вернулся, как и ошибки от путов.

[Ссылка на результат](https://overload.yandex.net/350872#tab=test_data&tags=&plot_groups=main&machines=&metrics=&slider_start=1605540163&slider_end=1605540463&compress_ratio=1)

Подводя итог можно сказать что утилита в освоении не сложнее Wrk, особенно с лекцией в виде пример аперед глазами. Но в ней сильно более наглядно видно какие именно запросы приходят, и это большой плюс
(Говорю это как человек, который в первом этапе настрелял гетами по пустой базе и не заметил). И в целом утилита выглядит более наглядной и вариативной.
